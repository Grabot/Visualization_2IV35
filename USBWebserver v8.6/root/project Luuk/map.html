<!DOCTYPE html>
<meta charset="utf-8">

<style>
    .bar {
        fill: steelblue;
    }

    .axis text {
        font: 10px sans-serif;
    }

    .bar:hover {
        fill: brown;
    }

    .axis {
        font: 10px sans-serif;
    }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
</style>

<html>


<body>


    <!--  <svg class="chart">
    </svg>-->

    <div class="log" />

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script>
        var cityData = d3.map();

        queue()
           .defer(d3.json, "cities-geometry.json")
           .defer(d3.tsv, "cities-data.txt", function (d) {
               //var agevalues = {
               //    "P_00_04_JR": d.P_00_04_JR, "P_05_09_JR": d.P_05_09_JR,
               //    "P_10_14_JR": d.P_10_14_JR, "P_15_19_JR": d.P_15_19_JR,
               //    "P_20_24_JR": d.P_20_24_JR, "P_25_29_JR": d.P_25_29_JR,
               //    "P_30_34_JR": d.P_30_34_JR, "P_35_39_JR": d.P_35_39_JR,
               //    "P_40_44_JR": d.P_40_44_JR, "P_45_49_JR": d.P_45_49_JR,
               //    "P_50_54_JR": d.P_50_54_JR, "P_55_59_JR": d.P_55_59_JR,
               //    "P_60_64_JR": d.P_60_65_JR, "P_65_69_JR": d.P_65_69_JR,
               //    "P_70_74_JR": d.P_70_74_JR, "P_75_79_JR": d.P_75_79_JR,
               //    "P_80_84_JR": d.P_80_84_JR, "P_85_89_JR": d.P_85_89_JR,
               //    "P_90_94_JR": d.P_90_94_JR, "P_95_EO_JR": d.P_95_EO_JR
               //};

               var agevalues = d3.map();
               agevalues.set("P_00_04_JR", d.P_00_04_JR); agevalues.set("P_05_09_JR", d.P_05_09_JR);
               agevalues.set("P_10_14_JR", d.P_10_14_JR); agevalues.set("P_15_19_JR", d.P_15_19_JR);
               agevalues.set("P_20_24_JR", d.P_20_24_JR); agevalues.set("P_25_29_JR", d.P_25_29_JR);
               agevalues.set("P_30_34_JR", d.P_30_34_JR); agevalues.set("P_35_39_JR", d.P_35_39_JR);
               agevalues.set("P_40_44_JR", d.P_40_44_JR); agevalues.set("P_45_49_JR", d.P_45_49_JR);
               agevalues.set("P_50_54_JR", d.P_50_54_JR); agevalues.set("P_55_59_JR", d.P_55_59_JR);
               agevalues.set("P_60_64_JR", d.P_60_65_JR); agevalues.set("P_65_69_JR", d.P_65_69_JR);
               agevalues.set("P_70_74_JR", d.P_70_74_JR); agevalues.set("P_75_79_JR", d.P_75_79_JR);
               agevalues.set("P_80_84_JR", d.P_80_84_JR); agevalues.set("P_85_89_JR", d.P_85_89_JR);
               agevalues.set("P_90_94_JR", d.P_90_94_JR); agevalues.set("P_95_EO_JR", d.P_95_EO_JR);

               cityData.set(d.Code, agevalues);
           })
           .await(dataLoaded);




        function dataLoaded(error, mapData) {

            var barWidth = 40;

            var margin = { top: 20, right: 30, bottom: 30, left: 40 };
            var width = (barWidth + 10) * cityData.entries()[10].value.values().length; -margin.left - margin.right;
            var height = 200 - margin.top - margin.bottom;

            //var x = d3.scale.ordinal().rangeRoundBands([0, width], .1);

            //var y = d3.scale.linear().range([height, 0]);

            var x = d3.scale.linear().domain([0, cityData.entries()[10].value.values().length]).range([0, width]);
            //var y = d3.scale.linear().range([d3.max(cityData.entries()[10].value.values()) / 100, 0]).rangeRound([0, height]);
            var y = d3.scale.linear().range([height, 0]).domain([0, d3.max(cityData.entries()[10].value.values()) / 100]);
            //var y = d3.scale.linear().range([height, 0]);

            var xAxis = d3.svg.axis().scale(x).orient("bottom");
            var yAxis = d3.svg.axis().scale(y).orient("left").ticks(10, "%");

            console.log("Width: " + width);
            console.log(cityData.entries()[10].value.values().length);


            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Percentage");

            svg.selectAll(".bar")
                .data(cityData.entries()[10].value.values())
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (data, index) { console.log(index); return x(index); })
                .attr("y", function (d) { return height - y(d / 100); })
                .attr("width", barWidth)
                .attr("height", function (d) { return y(d / 100); });

            //
            //.attr("width", x.rangeBand())
            //.attr("y", function (d) { return y(d.value); })
            //.attr("height", function (d) { return height - y(d.value); });
        };
    </script>

</body>
</html>
