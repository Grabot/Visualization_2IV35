<!DOCTYPE html>
<html>
<meta charset="utf-8">
<style>
	path {
	  stroke: grey;
	  stroke-width: 1px;
	  fill: white;
	}

	.axis {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

</style>

<body>
 <svg class="chart"></svg>
 <div class="log" />
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script>
		var width = 800;
		var	height = 800;

		var chart = d3.select(".chart").attr("width", width);

		var cityData = d3.map();
		var ageData = d3.map();

		var linearColorScale = d3.scale.linear()
			.domain([0.0, 100.0])
			.range(["white", "blue"]);

		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);

		// Setup the map projection for a good depiction of The Netherlands. The
		// projection is centered on the geographical center of the country, which
		// happens to be the city of Lunteren.
		var projection = d3.geo.albers()
			  .rotate([0, 0])
			  .center([5.6, 52.1])
			  .parallels([50, 53])
			  .scale(15000)
			  .translate([width/2,height/2]);

		var path = d3.geo.path().projection(projection);
		var CityDataArray = [];
		var ageRange = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5];
		var testData = [4, 8, 15, 16, 23, 42];
		var g = svg.append("g");
		var i = 0;

		var x;
        var y;

		queue()
		   .defer(d3.json, "cities-geometry.json")
		   .defer(d3.tsv, "cities-data.txt", function(d) 
		   	{
		   		CityDataArray[i] = d;
		   		i++
		   		cityData.set(d.Code, +d.AUTO_TOT);
		   	})
		   .await(dataLoaded);


		function dataLoaded(error, mapData) 
		{

			

			var maxValue = d3.max(cityData.values());
			//console.log("The maximum value is " + maxValue);			
			linearColorScale.domain([0.0, maxValue]); 

			g.selectAll("path")
			.data(mapData.features).enter()
			.append("path")
			.attr("d", path)
			.style("fill", function(d) { return linearColorScale(cityData.get(d.gm_code)); })
			.on("mouseover", function(){d3.select(this)
				.style("fill", "green");})
    		.on("mouseout", function(){d3.select(this)
    			.style("fill", function(d) { return linearColorScale(cityData.get(d.gm_code)); }); })
			.on("mousedown", cityClick)
			.append("title").text(function(d) {return d.gm_naam + ", " +
			cityData.get(d.gm_code); });
		}

		function cityClick(d) {
			
			for( k = 0; k < CityDataArray.length; k++ )
			{
				if( d.gm_code == CityDataArray[k].GM_CODE)
				{
					//console.log( "what the dee says, naam: " + d.gm_naam + " code: " + d.gm_code);
					//console.log( "what the mee says, naam: " + CityDataArray[k].GM_NAAM + " code: " + CityDataArray[k].GM_CODE + " extra info: " + CityDataArray[k].P_00_04_JR );
					
					ageRange[0] = CityDataArray[k].P_00_04_JR;
					ageRange[1] = CityDataArray[k].P_05_09_JR;
					ageRange[2] = CityDataArray[k].P_10_14_JR;
					ageRange[3] = CityDataArray[k].P_15_19_JR;
					ageRange[4] = CityDataArray[k].P_20_24_JR;
					ageRange[5] = CityDataArray[k].P_25_29_JR;
					ageRange[6] = CityDataArray[k].P_30_34_JR;
					ageRange[7] = CityDataArray[k].P_35_39_JR;
					ageRange[8] = CityDataArray[k].P_40_44_JR;
					ageRange[9] = CityDataArray[k].P_45_49_JR;
					ageRange[10] = CityDataArray[k].P_50_54_JR;
					ageRange[11] = CityDataArray[k].P_55_59_JR;
					ageRange[12] = CityDataArray[k].P_60_65_JR;
					ageRange[13] = CityDataArray[k].P_65_69_JR;
					ageRange[14] = CityDataArray[k].P_70_74_JR;
					ageRange[15] = CityDataArray[k].P_75_79_JR;
					ageRange[16] = CityDataArray[k].P_80_84_JR;
					ageRange[17] = CityDataArray[k].P_85_89_JR;
					ageRange[18] = CityDataArray[k].P_90_94_JR;
					ageRange[19] = CityDataArray[k].P_95_EO_JR;
					
				}
			}
			var width;
			var barWidth = 40;

			var barHeight = 200;

			width = (barWidth + 10) * ageRange.length;
            x = d3.scale.linear().domain([0, ageRange.length]).range([0, width]);
            y = d3.scale.linear().domain([0, d3.max(ageRange)]).rangeRound([0, height]);

			console.log("Width: " + width);

			d3.select(".chart")
                .attr("width", width)
                .attr("height", height)
            	.selectAll("rect")
            	.data(ageRange)
            	.enter().append("rect")
            	.style("fill", "steelblue")
            	.attr("x", function (data, index) { return x(index); })
            	.attr("y", function(d) { return height - y(d); })
            	.attr("width", barWidth)
            	.attr("height", height);
			
		};
	</script>
</body>
</html>
