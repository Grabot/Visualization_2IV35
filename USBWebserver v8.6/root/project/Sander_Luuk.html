<!DOCTYPE html>
<html>
<meta charset="utf-8">
<style>
	path {
	  stroke: grey;
	  stroke-width: 1px;
	  fill: white;
	}

	path:hover {
  		fill: red;
	}

	.bar {
        fill: steelblue;
    }

    .axis text {
        font: 10px sans-serif;
    }

    .bar:hover {
        fill: brown;
    }

    .axis {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
</style>

<body>
    <div class="log" > </div>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script>
		var width = 1600,
			height = 800;

		var cityData = d3.map();
		var ageData = d3.map();

		var linearColorScale = d3.scale.linear()
			.domain([0.0, 100.0])
			.range(["white", "blue"]);

		// Setup the map projection for a good depiction of The Netherlands. The
		// projection is centered on the geographical center of the country, which
		// happens to be the city of Lunteren.
		var projection = d3.geo.albers()
			  .rotate([0, 0])
			  .center([5.6, 52.1])
			  .parallels([50, 53])
			  .scale(15000)
			  .translate([width/4,height/2]);


		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);

		var g = svg.append("g");

		var path = d3.geo.path().projection(projection);
		var population = [];
		var ageRange = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5];

		var bar = svg.append("bar");
		var i = 0;

		queue()
		   .defer(d3.json, "cities-geometry.json")
		   .defer(d3.tsv, "cities-data.txt", function(d) 
		   	{
		   		population[i] = d;
		   		i++
		   		cityData.set(d.Code, +d.AUTO_TOT);
		   	})
		   .await(dataLoaded);


		function dataLoaded(error, mapData) 
		{
			var maxValue = d3.max(cityData.values());
			//console.log("The maximum value is " + maxValue);			
			linearColorScale.domain([0.0, maxValue]); 

			var barWidth = 40;

            x = d3.scale.linear().domain([0, ageRange.length]).range([700, 1600]);
            y = d3.scale.linear().domain([0, d3.max(ageRange)]).rangeRound([0, height]);

			var xAxis = d3.svg.axis().scale(x).orient("bottom");
            var yAxis = d3.svg.axis().scale(y).orient("left").ticks(10, "%");

			svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Percentage");



            svg.selectAll(".bar")
                .data(ageRange)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d, index) { return x(index); })
                .attr("y", function (d) { return height - y(d / 10); })
                .attr("width", barWidth)
                .attr("height", function (d) { return y(d / 10); });

			g.selectAll("path")
			.data(mapData.features).enter()
			.append("path")
			.attr("d", path)
			.style("fill", function(d) { return linearColorScale(cityData.get(d.gm_code)); })
			.on("mouseover", function(){d3.select(this)
				.style("fill", "green");})
    		.on("mouseout", function(){d3.select(this)
    			.style("fill", function(d) { return linearColorScale(cityData.get(d.gm_code)); }); })
			.on("mousedown", cityClick)
			.append("title").text(function(d) {return d.gm_naam + ", " +
			cityData.get(d.gm_code); });


		}

		function cityClick(d) {
			for( k = 0; k < population.length; k++ )
			{
				if( d.gm_code == population[k].GM_CODE)
				{
					//console.log( "what the dee says, naam: " + d.gm_naam + " code: " + d.gm_code);
					//console.log( "what the mee says, naam: " + population[k].GM_NAAM + " code: " + population[k].GM_CODE + " extra info: " + population[k].P_00_04_JR );
					ageRange[0] = population[k].P_00_04_JR;
					ageRange[1] = population[k].P_05_09_JR;
					ageRange[2] = population[k].P_10_14_JR;
					ageRange[3] = population[k].P_15_19_JR;
					ageRange[4] = population[k].P_20_24_JR;
					ageRange[5] = population[k].P_25_29_JR;
					ageRange[6] = population[k].P_30_34_JR;
					ageRange[7] = population[k].P_35_39_JR;
					ageRange[8] = population[k].P_40_44_JR;
					ageRange[9] = population[k].P_45_49_JR;
					ageRange[10] = population[k].P_50_54_JR;
					ageRange[11] = population[k].P_55_59_JR;
					ageRange[12] = population[k].P_60_65_JR;
					ageRange[13] = population[k].P_65_69_JR;
					ageRange[14] = population[k].P_70_74_JR;
					ageRange[15] = population[k].P_75_79_JR;
					ageRange[16] = population[k].P_80_84_JR;
					ageRange[17] = population[k].P_85_89_JR;
					ageRange[18] = population[k].P_90_94_JR;
					ageRange[19] = population[k].P_95_EO_JR;

				}
			}
            //console.log("x: " + d3.scale.linear().domain([0, ageRange.length]).range([0, width]) );
            d3.selectAll(".bar")
            	.data(ageRange).transition()
            	.duration(1000)
                .attr("y", function (d) { return height - y(d / 10); })
                .attr("height", function (d) { return height - y(d / 10); })


			/*
    		d3.select(this).transition()
        	.duration(1000)
        	.attr("r", 10)
      		.transition()
        	.delay(1000)
        	.attr("r", 40);
        	*/
		};



		/*
		var clicked =  function()
		{
		    console.log("naam: "); //considering dot has a title attribute
		}
		*/
	</script>
</body>
</html>
